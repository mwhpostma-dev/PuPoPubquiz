<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PuPo Familie Pubquiz 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .answer-btn { transition: all 0.2s ease-in-out; }
        .correct { background-color: #22c55e !important; color: white !important; border: 2px solid white; transform: scale(1.05); }
        .incorrect { background-color: #ef4444 !important; color: white !important; opacity: 0.7; }
        .selected { background-color: #6366f1 !important; color: white !important; border: 2px solid white; }
        .disabled-btn { pointer-events: none; opacity: 0.6; }
        #timer-bar-inner { transition: width 1s linear; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 flex items-center justify-center min-h-screen p-4">

    <!-- Start Screen -->
    <div id="start-screen" class="w-full max-w-md bg-white dark:bg-slate-800 shadow-2xl rounded-2xl p-8 text-center">
        <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-6">PuPo Familie Pubquiz 2026</h1>
        <div class="space-y-4">
            <input type="text" id="player-name" placeholder="Voer je naam in" class="w-full p-3 rounded-lg bg-slate-200 dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <input type="text" id="game-id-input" placeholder="Voer Spel ID in (om mee te doen)" class="w-full p-3 rounded-lg bg-slate-200 dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="join-game-btn" class="w-full bg-emerald-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-emerald-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-wait" disabled>Doe mee met spel</button>
            <p class="text-slate-500 dark:text-slate-400">of</p>
            <button id="create-game-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-wait" disabled>Maak nieuw spel (Quizmaster)</button>
        </div>
        <p id="start-error" class="text-slate-500 mt-4 h-4">Bezig met verbinden...</p>
    </div>

    <!-- Quiz Container -->
    <div id="quiz-container" class="hidden w-full max-w-4xl bg-white dark:bg-slate-800 shadow-2xl rounded-2xl p-6 md:p-8 text-center">
        <div class="flex flex-col md:flex-row gap-8">
            <!-- Left Side: Quiz -->
            <div class="w-full md:w-2/3">
                <div class="flex justify-between items-center mb-2 text-lg">
                     <p>Vraag <span id="question-number">1</span>/<span id="total-questions">10</span></p>
                     <div id="game-id-container" class="text-sm">Spel ID: <strong id="game-id-display" class="cursor-pointer" title="Klik om te kopiëren"></strong></div>
                </div>
                 <div id="timer" class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mb-4">
                    <div id="timer-bar-inner" class="bg-indigo-500 h-2.5 rounded-full" style="width: 100%"></div>
                </div>
                <hr class="border-slate-200 dark:border-slate-700 mb-6">

                <div id="question-area">
                    <h3 id="round-name" class="text-xl font-bold text-indigo-400 mb-2"></h3>
                    <h2 id="question-text" class="text-2xl font-semibold mb-6 h-24 flex items-center justify-center">Wachten op de quizmaster...</h2>
                    <p id="answer-feedback" class="text-lg font-semibold my-4 h-8"></p>
                    <div id="answer-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>

                <div class="mt-8 flex justify-end">
                    <button id="next-btn" class="hidden bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors duration-200">Volgende Vraag</button>
                </div>
            </div>

            <!-- Right Side: Scoreboard -->
            <div class="w-full md:w-1/3 border-t-2 md:border-t-0 md:border-l-2 border-slate-200 dark:border-slate-700 pt-6 md:pt-0 md:pl-6">
                 <h3 class="text-2xl font-bold mb-4 text-indigo-600 dark:text-indigo-400">Scorebord</h3>
                 <div id="scoreboard" class="space-y-2 text-left">
                    <!-- Scores will be populated here -->
                 </div>
            </div>
        </div>
         <!-- Final Score Screen -->
        <div id="score-screen" class="hidden">
             <h2 class="text-3xl font-bold mb-4">Quiz Voltooid!</h2>
             <p id="score-feedback" class="text-lg mb-8"></p>
             <button id="restart-btn" class="hidden bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-colors duration-200">Nieuw Spel Starten</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- VRAGEN ---
        const quizRounds = [
            {
                name: "Algemeen",
                questions: [
                    { question: "Wat is de hoofdstad van Nederland?", answers: ["Amsterdam", "Rotterdam", "Den Haag", "Utrecht"], correctAnswerIndex: 0 },
                    { question: "Hoeveel provincies heeft Nederland?", answers: ["10", "11", "12", "13"], correctAnswerIndex: 2 },
                ]
            },
            {
                name: "Waar of niet waar?",
                questions: [
                    { question: "Een groep kraaien wordt ook wel een moord genoemd", answers: ["Waar", "Niet waar"], correctAnswerIndex: 0 },
                    { question: "Het Oktoberfest begint traditioneel in september", answers: ["Waar", "Niet waar"], correctAnswerIndex: 0 }},
                ]
            },
 	    {
                name: "Sport",
                questions: [
                    { question: "Hoe vaak won Mighty Mike het WK?", answers: ["2", "3", "4", "0"], correctAnswerIndex: 1 },
                    { question: "Curaçao plaatste zich in November 2025 voor het WK voetbal. Wie is de bondscoach van dit team?", answers: ["Guus Hiddink", "Stanley Menzo", "Ruud Gullit", "Dick Advocaat"], correctAnswerIndex: 3 },
                ]
            },
            {
                name: "Muziek",
                questions: [
                    { question: "Wie wordt 'The King of Pop' genoemd?", answers: ["Elvis Presley", "Michael Jackson", "Freddie Mercury", "Elton John"], correctAnswerIndex: 1 },
                    { question: "Van welk land komt de band ABBA?", answers: ["Noorwegen", "Denemarken", "Finland", "Zweden"], correctAnswerIndex: 3 },
                ]
            },
            {
                name: "Familie",
                questions: [
                    { question: "Wat is de geboortemaand van de meeste mensen in onze familie?", answers: ["Januari", "Mei", "Augustus", "Oktober"], correctAnswerIndex: 2 },
                    { question: "Welk spel spelen we het vaakst op familieweekenden?", answers: ["Catan", "30 Seconds", "Monopoly", "Kaarten"], correctAnswerIndex: 1 },
                ]
            }
        ];

        // --- ELEMENTEN ---
        const startScreen = document.getElementById('start-screen');
        const quizContainer = document.getElementById('quiz-container');
        const playerNameInput = document.getElementById('player-name');
        const gameIdInput = document.getElementById('game-id-input');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const startError = document.getElementById('start-error');
        const roundNameEl = document.getElementById('round-name');
        const questionTextEl = document.getElementById('question-text');
        const answerButtonsEl = document.getElementById('answer-buttons');
        const nextBtn = document.getElementById('next-btn');
        const gameIdDisplay = document.getElementById('game-id-display');
        const scoreboard = document.getElementById('scoreboard');
        const questionNumberEl = document.getElementById('question-number');
        const totalQuestionsEl = document.getElementById('total-questions');
        const scoreScreen = document.getElementById('score-screen');
        const scoreFeedbackEl = document.getElementById('score-feedback');
        const restartBtn = document.getElementById('restart-btn');
        const timerBar = document.getElementById('timer-bar-inner');
        const answerFeedbackEl = document.getElementById('answer-feedback');
        
        // --- FIREBASE & APP STATE ---
        let app, db, auth;
        let userId, playerName, gameId, isQuizmaster = false;
        let playerDocId;
        let playerAnsweredIndex = null;
        let unsubscribeGame, unsubscribePlayers;
        let currentGameState = {};
        let timerInterval;
        const QUESTION_TIME = 20;

        const appId = 'default-pubquiz-app';

        // --- FIREBASE CONFIGURATIE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBKjOEFstlsSU4DoBRS_QzWGbUEneK7A08",
            authDomain: "pupo-pub-wuiz.firebaseapp.com",
            projectId: "pupo-pub-wuiz",
            storageBucket: "pupo-pub-wuiz.appspot.com",
            messagingSenderId: "253915553323",
            appId: "1:253915553323:web:505a8f2a42e12c1845d46e"
        };
        // --- EINDE CONFIGURATIE ---

        async function initialize() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        createGameBtn.disabled = false;
                        joinGameBtn.disabled = false;
                        startError.textContent = "";
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Firebase init failed:", error);
                startError.textContent = "Kon niet verbinden. Probeer opnieuw.";
            }
        }

        function validateInput(isJoining) {
            playerName = playerNameInput.value.trim();
            if (!playerName) {
                startError.textContent = "Vul alsjeblieft een naam in.";
                return false;
            }
            if (isJoining) {
                gameId = gameIdInput.value.trim(); 
                if (!gameId) {
                    startError.textContent = "Vul een Spel ID in om mee te doen.";
                    return false;
                }
            }
            startError.textContent = "";
            return true;
        }

        async function createGame() {
            if (!validateInput(false)) return;
            isQuizmaster = true;
            try {
                gameId = Math.floor(100000 + Math.random() * 900000).toString();
                const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);

                await setDoc(gameRef, {
                    quizmasterId: userId,
                    currentRoundIndex: -1,
                    currentQuestionIndex: -1,
                    rounds: quizRounds,
                    isRevealingAnswers: false,
                    createdAt: new Date()
                });

                await setupPlayer();
                startGameListeners();
            } catch (error) {
                console.error("Error creating game:", error);
                startError.textContent = "Kon spel niet aanmaken.";
            }
        }

        async function joinGame() {
            if (!validateInput(true)) return;
            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}`);
                const gameSnap = await getDoc(gameRef);
                if (!gameSnap.exists()) {
                    startError.textContent = "Spel ID niet gevonden.";
                    return;
                }
                isQuizmaster = false;
                await setupPlayer();
                startGameListeners();
            } catch (error) {
                console.error("Error joining game:", error);
                startError.textContent = "Kon niet meedoen met spel.";
            }
        }
        
        async function setupPlayer() {
            const playersCollectionRef = collection(db, `artifacts/${appId}/public/data/games/${gameId}/players`);
            const playerDocRef = await addDoc(playersCollectionRef, {
                name: playerName,
                score: 0,
                isQuizmaster: isQuizmaster,
                authId: userId
            });
            playerDocId = playerDocRef.id;
        }
        
        function startGameListeners() {
            startScreen.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            gameIdDisplay.textContent = gameId;

            if (!isQuizmaster) {
                document.getElementById('game-id-container').classList.add('hidden');
            }

            const gameRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}`);
            unsubscribeGame = onSnapshot(gameRef, (docSnap) => handleGameStateUpdate(docSnap.data()));

            const playersRef = collection(db, `artifacts/${appId}/public/data/games/${gameId}/players`);
            unsubscribePlayers = onSnapshot(playersRef, (querySnapshot) => {
                const players = [];
                querySnapshot.forEach((doc) => players.push({ id: doc.id, ...doc.data() }));
                updateScoreboard(players);
            });
        }

        function handleGameStateUpdate(gameState) {
            if (!gameState) return;
            
            const oldState = currentGameState;
            currentGameState = gameState;
            const { currentRoundIndex, currentQuestionIndex } = gameState;

            // Update on state change
            if (currentRoundIndex !== oldState.currentRoundIndex || currentQuestionIndex !== oldState.currentQuestionIndex) {
                 updateDisplay(gameState);
            }
            
            if (gameState.isRevealingAnswers && !oldState.isRevealingAnswers) {
                revealAnswers();
            }
        }

        function updateDisplay(gameState) {
            const { currentRoundIndex, currentQuestionIndex, rounds } = gameState;

            // Hide everything by default
            answerButtonsEl.innerHTML = '';
            answerFeedbackEl.textContent = '';
            nextBtn.classList.add('hidden');
            roundNameEl.textContent = '';
            
            // Total quiz lobby
            if (currentRoundIndex === -1) {
                if (isQuizmaster) {
                    questionTextEl.textContent = "Deel de Spel ID en klik op 'Start Quiz' om te beginnen.";
                    nextBtn.textContent = "Start Quiz";
                    nextBtn.classList.remove('hidden');
                } else {
                    questionTextEl.textContent = "Wachten op de quizmaster om te starten...";
                }
                return;
            }
            
            // End of quiz
            if (currentRoundIndex >= rounds.length) {
                showFinalScore();
                return;
            }

            const currentRound = rounds[currentRoundIndex];
            roundNameEl.textContent = `Ronde: ${currentRound.name}`;

            // Pre-round lobby
            if (currentQuestionIndex === -1) {
                if (isQuizmaster) {
                    questionTextEl.textContent = `Klaar voor de ronde "${currentRound.name}"?`;
                    nextBtn.textContent = `Start Ronde`;
                    nextBtn.classList.remove('hidden');
                } else {
                    questionTextEl.textContent = `De volgende ronde is "${currentRound.name}". Wacht op de quizmaster.`;
                }
                 return;
            }

            // Display question
            displayQuestion();
        }


        function displayQuestion() {
            scoreScreen.classList.add('hidden');
            questionTextEl.parentElement.classList.remove('hidden');
            resetStateForNewQuestion();

            const { currentRoundIndex, currentQuestionIndex, rounds } = currentGameState;
            const round = rounds[currentRoundIndex];
            const question = round.questions[currentQuestionIndex];
            
            questionTextEl.textContent = question.question;
            questionNumberEl.textContent = currentQuestionIndex + 1;
            totalQuestionsEl.textContent = round.questions.length;

            question.answers.forEach((answer, index) => {
                const button = document.createElement('button');
                button.innerText = answer;
                button.classList.add('answer-btn', 'w-full', 'bg-slate-200', 'dark:bg-slate-700', 'p-4', 'rounded-lg', 'text-lg', 'hover:bg-slate-300', 'dark:hover:bg-slate-600');
                button.dataset.index = index;
                
                if (!isQuizmaster) {
                    button.addEventListener('click', selectAnswer);
                } else {
                    button.classList.add('disabled-btn');
                }
                
                answerButtonsEl.appendChild(button);
            });
            startTimer();
        }
        
        function revealAnswers() {
            clearInterval(timerInterval);
            const { currentRoundIndex, currentQuestionIndex, rounds } = currentGameState;
            const question = rounds[currentRoundIndex].questions[currentQuestionIndex];
            const correctAnswerIndex = question.correctAnswerIndex;
            
            if (!isQuizmaster && playerAnsweredIndex !== null) {
                if (playerAnsweredIndex === correctAnswerIndex) {
                    (async () => {
                        const playerRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/players/${playerDocId}`);
                        const playerSnap = await getDoc(playerRef);
                        if (playerSnap.exists()) {
                           const currentScore = playerSnap.data().score;
                           await updateDoc(playerRef, { score: currentScore + 1 });
                        }
                    })();
                }
            }
            
            Array.from(answerButtonsEl.children).forEach((button, index) => {
                button.classList.add('disabled-btn');
                if (index === correctAnswerIndex) {
                    button.classList.add('correct');
                    button.classList.remove('selected');
                } else if (button.classList.contains('selected')) {
                    button.classList.add('incorrect');
                }
            });

            if (!isQuizmaster) {
                if (playerAnsweredIndex !== null) {
                    if (playerAnsweredIndex === correctAnswerIndex) {
                        answerFeedbackEl.textContent = "Het antwoord is goed!";
                        answerFeedbackEl.className = 'text-lg font-semibold my-4 h-8 text-green-500';
                    } else {
                        answerFeedbackEl.textContent = "Helaas, het antwoord is fout.";
                        answerFeedbackEl.className = 'text-lg font-semibold my-4 h-8 text-red-500';
                    }
                } else {
                    answerFeedbackEl.textContent = "Helaas, je was te laat.";
                    answerFeedbackEl.className = 'text-lg font-semibold my-4 h-8 text-red-500';
                }
            }

            if (isQuizmaster) {
                nextBtn.textContent = 'Volgende Vraag';
                nextBtn.classList.remove('hidden');
            }
        }


        async function selectAnswer(e) {
            const selectedBtn = e.target;
            if (document.querySelector('.answer-btn.selected')) return;

            selectedBtn.classList.add('selected');
            Array.from(answerButtonsEl.children).forEach(button => button.classList.add('disabled-btn'));
            
            playerAnsweredIndex = parseInt(selectedBtn.dataset.index);
        }
        
        function updateScoreboard(players) {
            scoreboard.innerHTML = '';
            const participants = players.filter(p => !p.isQuizmaster);
            participants.sort((a, b) => b.score - a.score);
            participants.forEach(player => {
                const div = document.createElement('div');
                div.classList.add('flex', 'justify-between', 'items-center', 'p-2', 'rounded-md');
                if (player.id === playerDocId) div.classList.add('bg-indigo-100', 'dark:bg-indigo-900');
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = player.name;
                const scoreSpan = document.createElement('span');
                scoreSpan.textContent = player.score;
                scoreSpan.classList.add('font-bold');
                
                div.appendChild(nameSpan);
                div.appendChild(scoreSpan);
                scoreboard.appendChild(div);
            });
        }
        
        async function advanceGame() {
            const gameRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}`);
            let { currentRoundIndex, currentQuestionIndex, rounds, isRevealingAnswers } = currentGameState;

            // Case 1: Start of the entire quiz (from main lobby)
            if (currentRoundIndex === -1) {
                await updateDoc(gameRef, { 
                    currentRoundIndex: 0,
                    currentQuestionIndex: -1, // Go to the pre-round lobby for round 0
                    isRevealingAnswers: false
                });
                return;
            }

            // Case 2: Start of a new round (from pre-round lobby)
            if (currentQuestionIndex === -1 && currentRoundIndex < rounds.length) {
                 await updateDoc(gameRef, {
                    currentQuestionIndex: 0, // Start with the first question
                    isRevealingAnswers: false
                });
                return;
            }

            // Case 3: Revealing answers for the current question
            if (!isRevealingAnswers) {
                await updateDoc(gameRef, { isRevealingAnswers: true });
                return;
            }

            // Case 4: Moving to the next question or next round lobby
            const currentRound = rounds[currentRoundIndex];
            if (currentQuestionIndex < currentRound.questions.length - 1) {
                // More questions in this round
                await updateDoc(gameRef, {
                    currentQuestionIndex: currentQuestionIndex + 1,
                    isRevealingAnswers: false
                });
            } else {
                // End of round, go to next round's lobby
                await updateDoc(gameRef, {
                    currentRoundIndex: currentRoundIndex + 1,
                    currentQuestionIndex: -1,
                    isRevealingAnswers: false
                });
            }
        }

        function resetStateForNewQuestion() {
            nextBtn.classList.add('hidden');
            answerButtonsEl.innerHTML = '';
            answerFeedbackEl.textContent = '';
            playerAnsweredIndex = null;
        }
        
        function startTimer() {
            clearInterval(timerInterval);
            let timeLeft = QUESTION_TIME;
            timerBar.style.width = '100%';
            timerBar.classList.remove('bg-red-500');
            timerBar.classList.add('bg-indigo-500');

            timerInterval = setInterval(async () => {
                timeLeft--;
                const percentage = (timeLeft / QUESTION_TIME) * 100;
                timerBar.style.width = `${percentage}%`;
                if(timeLeft < 5) timerBar.classList.add('bg-red-500');
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if (isQuizmaster) {
                        const gameRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}`);
                        await updateDoc(gameRef, { isRevealingAnswers: true });
                    }
                }
            }, 1000);
        }

        function showFinalScore() {
            questionTextEl.parentElement.classList.add('hidden');
            nextBtn.classList.add('hidden');
            scoreScreen.classList.remove('hidden');
            
            const players = Array.from(scoreboard.children).map(child => ({
                name: child.querySelector('span:first-child').textContent,
                score: parseInt(child.querySelector('span:last-child').textContent)
            }));
            
            if (players.length > 0) {
                players.sort((a,b) => b.score - a.score);
                const winner = players[0];
                scoreFeedbackEl.innerHTML = `De winnaar is <strong class="text-indigo-500">${winner.name}</strong> met ${winner.score} punten!`;
            } else {
                 scoreFeedbackEl.textContent = "De quiz is voorbij!";
            }
            
            if(isQuizmaster) {
                restartBtn.classList.remove('hidden');
            }
        }
        
        function copyGameId() {
            navigator.clipboard.writeText(gameId).then(() => {
                const originalText = gameIdDisplay.textContent;
                gameIdDisplay.textContent = 'Gekopieerd!';
                setTimeout(() => { gameIdDisplay.textContent = originalText; }, 1500);
            });
        }
        
        // --- EVENT LISTENERS ---
        createGameBtn.addEventListener('click', createGame);
        joinGameBtn.addEventListener('click', joinGame);
        nextBtn.addEventListener('click', advanceGame);
        gameIdDisplay.addEventListener('click', copyGameId);
        restartBtn.addEventListener('click', createGame);
        
        initialize();
    </script>
</body>
</html>

